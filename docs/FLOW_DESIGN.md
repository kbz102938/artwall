# ArtWall 产品流程设计

## 一、整体用户流程

```
┌─────────────────────────────────────────────────────────────────┐
│                                                                 │
│  Landing Page ──▶ 选择家居风格 ──▶ 无限画作流                    │
│                                       ↓                         │
│                              持续追踪用户行为                     │
│                              (浏览、收藏、隐藏...)                │
│                                       ↓                         │
│                              实时更新推荐                        │
│                              推荐越来越精准                       │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

**核心理念：**
- 无需"测试"或"测验"，直接开始浏览
- 像约会 App 一样，用户的每个行为都在优化推荐
- 没有"最终结果页"，只有持续改进的无限流

---

## 二、页面结构与流程详解

### Page 1: Landing Page（首页）

**目的：** 介绍产品价值，引导用户开始

**页面元素：**
```
┌──────────────────────────────────────────┐
│  Logo: ArtWall                           │
├──────────────────────────────────────────┤
│                                          │
│  主标题: 找到真正适合你的画               │
│  副标题: 浏览、收藏、购买                 │
│          推荐越看越准                     │
│                                          │
│  ┌────────────────────────────────────┐  │
│  │                                    │  │
│  │    Hero Image                      │  │
│  │    (展示效果图：画挂在家中的样子)    │  │
│  │                                    │  │
│  └────────────────────────────────────┘  │
│                                          │
│         [ 开始探索 → ]  (CTA按钮)         │
│                                          │
├──────────────────────────────────────────┤
│  简要说明:                               │
│  ① 选择你喜欢的风格                      │
│  ② 浏览为你推荐的画作                    │
│  ③ 喜欢就收藏，越看越准                  │
├──────────────────────────────────────────┤
│  Footer: 关于我们 | 联系方式              │
└──────────────────────────────────────────┘
```

**交互：**
- 点击「开始探索」→ 检查是否有已保存偏好
  - 有：直接进入 Feed 页
  - 无：进入风格选择页

**Activity Tracking:**
- `session_start`: 用户进入网站

---

### Page 2: 选择家居风格（Onboarding）

**目的：** 建立用户初始偏好向量

**页面元素：**
```
┌──────────────────────────────────────────┐
│  进度条: [■■□□□] Step 1                  │
├──────────────────────────────────────────┤
│                                          │
│  标题: 选择你喜欢的家居风格               │
│  说明: 可选择 1-2 个，这将帮助我们推荐    │
│                                          │
│  ┌─────────┐ ┌─────────┐ ┌─────────┐    │
│  │         │ │         │ │         │    │
│  │ 现代简约 │ │  北欧   │ │ 日式侘寂 │    │
│  │         │ │         │ │         │    │
│  └─────────┘ └─────────┘ └─────────┘    │
│  ┌─────────┐ ┌─────────┐ ┌─────────┐    │
│  │         │ │         │ │         │    │
│  │  新中式  │ │ 法式轻奢 │ │  美式   │    │
│  │         │ │         │ │         │    │
│  └─────────┘ └─────────┘ └─────────┘    │
│  ┌─────────┐ ┌─────────┐                │
│  │         │ │         │                │
│  │  工业风  │ │ 奶油/混搭│                │
│  │         │ │         │                │
│  └─────────┘ └─────────┘                │
│                                          │
│            [ 开始浏览画作 → ]             │
│                                          │
└──────────────────────────────────────────┘
```

**交互：**
- 点击风格卡片 → 选中（高亮边框）
- 可选 1-2 个，至少选 1 个才能继续
- 点击「开始浏览画作」→ 保存偏好 → 进入 Feed 页

**数据：**
- 输出: `styleCodes: string[]` (如 `["modern", "nordic"]`)

**Activity Tracking:**
- `style_select`: 记录用户选择的风格

**API 调用：**
```
POST /api/onboarding/style
{
  "styleCodes": ["modern", "nordic"]
}

→ 创建用户初始 embedding (基于风格的预计算向量平均值)
```

---

### Page 3: 无限画作流（Feed）

**目的：** 展示个性化推荐，持续追踪用户行为

**页面元素：**
```
┌──────────────────────────────────────────┐
│  ArtWall              [🔍] [❤️ 收藏]      │
├──────────────────────────────────────────┤
│                                          │
│  为你推荐                                 │
│                                          │
│  ┌────────────────────────────────────┐  │
│  │                                    │  │
│  │           画作卡片 1                │  │
│  │                                    │  │
│  │  《星月夜》                         │  │
│  │  梵高 · 1889                       │  │
│  │                                    │  │
│  │  [❤️ 收藏]  [✕ 不喜欢]              │  │
│  └────────────────────────────────────┘  │
│                                          │
│  ┌────────────────────────────────────┐  │
│  │                                    │  │
│  │           画作卡片 2                │  │
│  │                                    │  │
│  └────────────────────────────────────┘  │
│                                          │
│  ┌────────────────────────────────────┐  │
│  │                                    │  │
│  │           画作卡片 3                │  │
│  │                                    │  │
│  └────────────────────────────────────┘  │
│                                          │
│  ...                                     │
│  (无限滚动加载)                          │
│                                          │
└──────────────────────────────────────────┘
```

**交互：**
- 滚动 → 自动加载更多画作
- 点击画作卡片 → 进入画作详情页
- 点击「收藏」→ 保存画作 + 更新推荐
- 点击「不喜欢」→ 隐藏画作 + 更新推荐（推荐远离此类画作）
- 点击「收藏」图标 → 进入收藏列表

**Activity Tracking（核心！）：**

| 用户行为 | Event | 信号权重 | 说明 |
|---------|-------|---------|------|
| 画作出现在屏幕 | `impression` | 0 | 仅记录曝光 |
| 画作停留 >1s | `view` | +0.1~0.3 | 根据停留时间调整 |
| 点击进入详情 | `click` | +0.2 | 表示兴趣 |
| 收藏画作 | `save` | +0.5 | 强烈喜欢 |
| 取消收藏 | `unsave` | -0.3 | 改变心意 |
| 点击"不喜欢" | `hide` | -0.5 | 强烈不喜欢 |
| 分享画作 | `share` | +0.4 | 喜欢 |
| 购买 | `purchase` | +1.0 | 最强信号 |

**API 调用：**
```
GET /api/feed?cursor=xxx&limit=10

→ 返回个性化推荐画作列表

POST /api/activity
{
  "events": [
    {"event": "view", "paintingId": "xxx", "metadata": {"dwellTimeMs": 4500}},
    {"event": "save", "paintingId": "yyy"}
  ]
}

→ 异步处理，更新用户 embedding
```

---

### Page 4: 画作详情页

**目的：** 展示画作详情，预览效果，引导购买

**页面元素：**
```
┌──────────────────────────────────────────┐
│  [← 返回]                    [❤️ 收藏]   │
├──────────────────────────────────────────┤
│                                          │
│  ┌────────────────────────────────────┐  │
│  │                                    │  │
│  │                                    │  │
│  │           画作大图                  │  │
│  │           (可放大查看)              │  │
│  │                                    │  │
│  │                                    │  │
│  └────────────────────────────────────┘  │
│                                          │
│  《星月夜》The Starry Night              │
│  文森特·梵高 Vincent van Gogh            │
│  1889 · 后印象派                         │
│                                          │
│  ─────────────────────────────────────── │
│                                          │
│  效果预览 (如有上传房间照片):             │
│  ┌────────────────────────────────────┐  │
│  │                                    │  │
│  │   (画作渲染到用户房间照片中)         │  │
│  │                                    │  │
│  └────────────────────────────────────┘  │
│                                          │
│  尺寸选择: [40x50] [50x60] [60x80]       │
│                                          │
│         [ 购买实体画作 → ]                │
│                                          │
│  ─────────────────────────────────────── │
│                                          │
│  你可能也喜欢:                            │
│  ┌─────┐ ┌─────┐ ┌─────┐ ┌─────┐        │
│  │     │ │     │ │     │ │     │        │
│  └─────┘ └─────┘ └─────┘ └─────┘        │
│                                          │
└──────────────────────────────────────────┘
```

**交互：**
- 点击画作图片 → 放大查看高清图
- 切换尺寸 → 更新效果预览
- 点击「购买实体画作」→ 跳转淘宝店铺 / 进入订单页
- 点击「收藏」→ 保存画作
- 点击相关画作 → 进入该画作详情

**Activity Tracking:**
- `click`: 进入详情页时记录
- `view`: 停留时间追踪
- `save`: 点击收藏
- `purchase`: 点击购买

**API 调用：**
```
GET /api/paintings/:id

→ 返回画作详细信息
```

---

### Page 5: 收藏列表

**目的：** 查看已收藏的画作

**页面元素：**
```
┌──────────────────────────────────────────┐
│  [← 返回]        我的收藏                │
├──────────────────────────────────────────┤
│                                          │
│  共收藏 12 幅画作                         │
│                                          │
│  ┌─────────┐ ┌─────────┐ ┌─────────┐    │
│  │         │ │         │ │         │    │
│  │  画作1   │ │  画作2   │ │  画作3   │    │
│  │         │ │         │ │         │    │
│  └─────────┘ └─────────┘ └─────────┘    │
│  ┌─────────┐ ┌─────────┐ ┌─────────┐    │
│  │         │ │         │ │         │    │
│  │  画作4   │ │  画作5   │ │  画作6   │    │
│  │         │ │         │ │         │    │
│  └─────────┘ └─────────┘ └─────────┘    │
│                                          │
│  ...                                     │
│                                          │
└──────────────────────────────────────────┘
```

**交互：**
- 点击画作 → 进入详情页
- 长按/右键 → 取消收藏

**API 调用：**
```
GET /api/saved

→ 返回用户收藏的画作列表
```

---

### Page 6: 上传房间照片（可选）

**目的：** 上传房间照片用于效果渲染

**位置：** 可从 Feed 页或详情页入口进入

**页面元素：**
```
┌──────────────────────────────────────────┐
│  [← 返回]        上传房间照片            │
├──────────────────────────────────────────┤
│                                          │
│  标题: 上传你想挂画的墙面照片              │
│  说明: 正面拍摄，光线清晰效果更好          │
│                                          │
│  ┌────────────────────────────────────┐  │
│  │                                    │  │
│  │   📷 点击上传 或 拖拽图片到这里      │  │
│  │                                    │  │
│  │   支持 JPG/PNG，最大 10MB           │  │
│  │                                    │  │
│  └────────────────────────────────────┘  │
│                                          │
│  (上传后显示预览图，可重新上传)            │
│                                          │
│              [ 确认上传 ]                 │
│                                          │
└──────────────────────────────────────────┘
```

**交互：**
- 上传图片 → 显示预览
- 点击「确认上传」→ 上传到 Cloud Storage + 获取 embedding

**API 调用：**
```
POST /api/upload
Content-Type: multipart/form-data

→ 返回图片 URL + embedding（用于混合用户偏好）
```

---

## 三、数据流设计

```
┌─────────────┐
│   用户行为   │
└──────┬──────┘
       │
       ▼
┌──────────────────────────────────────────────────────┐
│  Frontend Activity Tracker                           │
│                                                      │
│  - 收集所有用户行为                                   │
│  - 批量发送到后端 (每2秒或页面离开时)                  │
│  - 本地存储 visitorId (持久化)                        │
│  - 每次访问生成 sessionId                             │
│                                                      │
└──────────────────────────────────────────────────────┘
       │
       │ POST /api/activity
       ▼
┌──────────────────────────────────────────────────────┐
│  Next.js API                                         │
│                                                      │
│  - 验证事件格式                                       │
│  - 添加 visitorId, sessionId, timestamp              │
│  - 发布到 Pub/Sub                                    │
│  - 立即返回 (不等待处理)                              │
│                                                      │
└──────────────────────────────────────────────────────┘
       │
       │ Pub/Sub Message
       ▼
┌──────────────────────────────────────────────────────┐
│  Event Worker (Python)                               │
│                                                      │
│  - 接收 Pub/Sub 推送                                 │
│  - 解析事件                                          │
│  - 计算信号权重                                       │
│  - 更新用户 embedding                                │
│  - 保存到数据库                                       │
│                                                      │
└──────────────────────────────────────────────────────┘
       │
       ▼
┌──────────────────────────────────────────────────────┐
│  User Embedding (持续演化)                            │
│                                                      │
│  初始: 基于选择的家居风格                             │
│        ↓                                             │
│  演化: 每次用户行为都会微调                           │
│        - 收藏 → 向该画作方向移动                      │
│        - 隐藏 → 远离该画作方向                        │
│        ↓                                             │
│  结果: 推荐越来越个性化                               │
│                                                      │
└──────────────────────────────────────────────────────┘
```

---

## 四、API 接口设计

### 4.1 活动追踪

```
POST /api/activity

Request:
{
  "events": [
    {
      "event": "view",
      "paintingId": "p001",
      "position": 3,
      "source": "feed",
      "metadata": {
        "dwellTimeMs": 4500
      }
    },
    {
      "event": "save",
      "paintingId": "p002"
    }
  ]
}

Response:
{
  "success": true,
  "logged": 2
}
```

### 4.2 获取个性化 Feed

```
GET /api/feed?cursor=xxx&limit=10

Response:
{
  "paintings": [
    {
      "id": "p001",
      "title": "星月夜",
      "titleEn": "The Starry Night",
      "artist": "梵高",
      "artistEn": "Vincent van Gogh",
      "year": 1889,
      "imageUrl": "https://...",
      "similarity": 0.89
    },
    // ...
  ],
  "nextCursor": "xxx",
  "hasMore": true
}
```

### 4.3 设置初始风格偏好

```
POST /api/onboarding/style

Request:
{
  "styleCodes": ["modern", "nordic"]
}

Response:
{
  "success": true
}
```

### 4.4 获取画作详情

```
GET /api/paintings/:id

Response:
{
  "painting": {
    "id": "p001",
    "title": "星月夜",
    "titleEn": "The Starry Night",
    "artist": "梵高",
    "artistEn": "Vincent van Gogh",
    "year": 1889,
    "style": "后印象派",
    "imageUrl": "https://...",
    "imageHdUrl": "https://...",
    "source": "MoMA",
    "sourceUrl": "https://...",
    "isSaved": true
  }
}
```

### 4.5 获取收藏列表

```
GET /api/saved

Response:
{
  "paintings": [...],
  "total": 12
}
```

### 4.6 上传房间照片

```
POST /api/upload
Content-Type: multipart/form-data
Body: { image: File }

Response:
{
  "imageUrl": "https://storage.../xxx.jpg",
  "embedding": [0.023, -0.156, ...]
}
```

---

## 五、推荐算法简述

### 5.1 初始化用户 Embedding

```
用户选择风格: ["modern", "nordic"]
    ↓
查找预计算的风格 embedding
    ↓
取平均值并归一化
    ↓
保存为用户初始 embedding
```

### 5.2 持续更新用户 Embedding

```python
def update_embedding(user_embedding, painting_embedding, signal_weight):
    """
    signal_weight > 0: 向画作方向移动 (喜欢)
    signal_weight < 0: 远离画作方向 (不喜欢)
    """
    direction = painting_embedding - user_embedding
    new_embedding = user_embedding + learning_rate * signal_weight * direction
    return normalize(new_embedding)
```

### 5.3 生成推荐 Feed

```sql
SELECT id, title, artist, image_url,
       1 - (embedding <=> user_embedding) AS similarity
FROM paintings
WHERE id NOT IN (SELECT painting_id FROM shown_paintings WHERE visitor_id = ?)
ORDER BY similarity DESC
LIMIT 10;
```

---

## 六、页面路由

| 路由 | 页面 | 说明 |
|-----|------|------|
| `/` | Landing Page | 首页 |
| `/onboarding` | 选择家居风格 | 新用户引导 |
| `/feed` | 无限画作流 | 主要浏览页 |
| `/painting/:id` | 画作详情 | 画作详情页 |
| `/saved` | 收藏列表 | 已收藏画作 |
| `/upload` | 上传照片 | 房间照片上传 |

---

## 七、MVP 范围

### 包含:
- [x] Landing Page
- [x] 选择家居风格 (Onboarding)
- [x] 无限画作流 (Feed)
- [x] 画作详情页
- [x] 收藏功能
- [x] 活动追踪系统
- [x] 个性化推荐 (embedding-based)

### 不包含 (V2):
- [ ] 效果渲染预览 (需要 AI 图像合成)
- [ ] 用户注册/登录
- [ ] 在线支付
- [ ] 订单管理
- [ ] 风水模块
- [ ] 画框/材质推荐
- [ ] AI 生成画作

---

*文档版本: v2.0*
*更新日期: 2025-12-30*
*关键变更:
- 移除 5 轮偏好测试，改为持续追踪
- 移除"最终结果页"，改为无限流
- 新增活动追踪系统
- 新增 embedding 持续更新机制*
